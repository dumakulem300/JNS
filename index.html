<html><head><base href="." /><title>JNS Rewards System - Login</title>
  <style>
  :root {
    --bg-primary: #1a1a1a;
    --bg-secondary: #252525;
    --text-primary: #ffffff;
    --accent: #7c4dff;
    --error: #ff4d4d;
    --success: #4dff4d;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', system-ui, sans-serif;
  }
  
  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background-image: url('/a/0d67403a-a8c1-4e8e-8155-b2c37ba88d23');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }
  
  .container {
    width: 100%;
    max-width: 400px;
    padding: 2rem;
  }
  
  .auth-form {
    background: rgba(37, 37, 37, 0.95);
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    backdrop-filter: blur(5px);
  }
  
  h1 {
    text-align: center;
    margin-bottom: 2rem;
    color: var(--accent);
  }
  
  .input-group {
    margin-bottom: 1.5rem;
  }
  
  .input-group label {
    display: block;
    margin-bottom: 0.5rem;
  }
  
  .input-group input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #444;
    background: var(--bg-primary);
    color: var(--text-primary);
    border-radius: 5px;
    outline: none;
  }
  
  .input-group input:focus {
    border-color: var(--accent);
  }
  
  button {
    width: 100%;
    padding: 0.75rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: opacity 0.2s;
  }
  
  button:hover {
    opacity: 0.9;
  }
  
  .switch-form {
    text-align: center;
    margin-top: 1rem;
  }
  
  .switch-form a {
    color: var(--accent);
    text-decoration: none;
  }
  
  /* Admin styles */
  .admin-panel {
    display: none;
    max-width: 800px;
    background: rgba(37, 37, 37, 0.95);
    backdrop-filter: blur(5px);
    padding: 2rem;
    border-radius: 10px;
  }
  
  .user-list {
    width: 100%;
    border-collapse: collapse;
    margin-top: 2rem;
  }
  
  .user-list th, .user-list td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #444;
  }
  
  .action-btn {
    padding: 0.5rem 1rem;
    margin: 0.25rem;
    border-radius: 3px;
  }
  
  .delete-btn {
    background: var(--error);
  }
  
  .reset-btn {
    background: var(--accent);
  }
  
  .points {
    color: var(--accent);
    font-weight: bold;
  }
  
  .notifications {
    margin-bottom: 2rem;
    max-height: 300px;
    overflow-y: auto;
  }

  .notification {
    background: rgba(26, 26, 26, 0.95);
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 5px;
    border-left: 3px solid var(--accent);
  }

  .notification-time {
    color: #888;
    font-size: 0.8rem;
  }

  /* Add this to the existing CSS */
  .warning-message {
    background: rgba(37, 37, 37, 0.95);
    border-left: 4px solid var(--error);
    padding: 1rem;
    margin-top: 1rem;
    border-radius: 5px;
    font-size: 0.95rem;
    line-height: 1.4;
    backdrop-filter: blur(5px);
  }

  .warning-message strong {
    color: var(--error);
    display: block;
    margin-bottom: 0.5rem;
  }

  /* Add this to the existing CSS */
  .leaderboard {
    background: rgba(37, 37, 37, 0.95);
    padding: 1.5rem;
    border-radius: 10px;
    margin-top: 1rem;
    backdrop-filter: blur(5px);
  }

  .leaderboard h2 {
    color: var(--accent);
    margin-bottom: 1rem;
    text-align: center;
  }

  .leaderboard-list {
    list-style: none;
  }

  .leaderboard-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #444;
    transition: background-color 0.2s;
  }

  .leaderboard-item:hover {
    background: rgba(124, 77, 255, 0.1);
  }

  .leaderboard-rank {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--accent);
    width: 40px;
  }

  .leaderboard-username {
    flex-grow: 1;
    margin-left: 1rem;
  }

  .leaderboard-points {
    font-weight: bold;
    color: var(--accent);
  }

  .leaderboard-item.current-user {
    background: rgba(124, 77, 255, 0.2);
    border-left: 3px solid var(--accent);
  }

  .timer-container {
    margin: 1rem 0;
    text-align: center;
  }

  .timer-display {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--accent);
    text-shadow: 0 0 10px rgba(124, 77, 255, 0.3);
    margin-bottom: 0.5rem;
  }

  .timer-progress {
    width: 100%;
    height: 6px;
    background: rgba(124, 77, 255, 0.2);
    border-radius: 3px;
    overflow: hidden;
  }

  #timerProgressBar {
    height: 100%;
    background: var(--accent);
    width: 100%;
    transition: width 1s linear;
  }
  
  .bonus-controls {
    background: rgba(37, 37, 37, 0.95);
    padding: 1rem;
    border-radius: 5px;
    margin: 1rem 0;
  }

  .bonus-controls h3 {
    color: var(--accent);
    margin-bottom: 1rem;
  }

  .bonus-controls .input-group {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .bonus-controls input {
    flex: 2;
    padding: 0.75rem;
    border: 1px solid #444;
    background: var(--bg-primary);
    color: var(--text-primary);
    border-radius: 5px;
    outline: none;
  }

  .bonus-controls .action-btn {
    flex: 1;
    min-width: 120px;
  }

  .bonus-controls select {
    padding: 0.75rem;
    border: 1px solid #444;
    background: var(--bg-primary);
    color: var(--text-primary);
    border-radius: 5px;
    outline: none;
  }

  .bonus-controls select:focus {
    border-color: var(--accent);
  }

  .bonus-section {
    background: rgba(37, 37, 37, 0.95);
    padding: 1rem;
    border-radius: 5px;
    text-align: center;
  }

  .bonus-amount {
    font-size: 1.2rem;
    color: var(--accent);
    font-weight: bold;
  }

  #claimBonusBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Add this to the existing CSS */
  .start-timer-btn {
    background: #ff7043; 
    color: white;
    padding: 0.75rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
    width: 100%;
    margin-top: 1rem;
  }

  .start-timer-btn:hover {
    background: #f4511e;
  }

  .start-timer-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Add to existing CSS */
  .roulette-container {
    margin: 2rem 0;
    text-align: center;
  }

  .roulette-wheel {
    width: 300px;
    height: 300px;
    border-radius: 50%;
    border: 10px solid var(--accent);
    margin: 0 auto;
    position: relative;
    transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
    background: var(--bg-secondary);
  }

  .wheel-section {
    position: absolute;
    width: 50%;
    height: 50%;
    clip-path: polygon(100% 50%, 50% 50%, 50% 0%);
    transform-origin: bottom right;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 20px;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  }

  .wheel-pointer {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 20px solid var(--accent);
  }

  .spin-btn {
    background: var(--accent);
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 1rem;
    transition: all 0.2s;
  }

  .spin-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .points-display {
    display: flex;
    justify-content: space-around;
    margin: 1rem 0;
  }

  .points-item {
    text-align: center;
  }

  .points-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--accent);
  }

  .donation-container {
    margin-top: 2rem;
    background: rgba(37, 37, 37, 0.95);
    padding: 1.5rem;
    border-radius: 10px;
  }

  .donation-container h3 {
    color: var(--accent);
    margin-bottom: 1rem;
    text-align: center;
  }

  .donation-info {
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #888;
    text-align: center;
  }
  </style>
  </head>
  <body>
  <div class="container" id="loginContainer">
    <form class="auth-form" id="loginForm">
      <h1>JNS Internet Shop</h1>
      <h2>Claim your points!!!</h2>
      <div class="input-group">
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" required>
      </div>
      <div class="input-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" required>
      </div>
      <button type="submit">Login</button>
      <div class="switch-form">
        <a href="#" id="showRegister">Need an account? Register</a>
      </div>
    </form>
  </div>
  
  <div class="container" id="registerContainer" style="display: none;">
    <form class="auth-form" id="registerForm">
      <h1>Register</h1>
      <div class="input-group">
        <label for="regUsername">Username</label>
        <input type="text" id="regUsername" required>
      </div>
      <div class="input-group">
        <label for="regPassword">Password</label>
        <input type="password" id="regPassword" required>
      </div>
      <button type="submit">Register</button>
      <div class="switch-form">
        <a href="#" id="showLogin">Already have an account? Login</a>
      </div>
    </form>
  </div>
  
  <div class="container admin-panel" id="adminContainer">
    <h1>Admin Panel</h1>
    <div class="notifications" id="adminNotifications">
      <h2>Recent Claims</h2>
      <!-- Notifications will be inserted here -->
    </div>
    <button id="adminLogout" style="margin-bottom: 1rem;">Logout</button>
    <div class="bonus-controls">
      <h3>Give Bonus Points</h3>
      <div class="input-group">
        <input type="number" id="bonusPoints" min="1" placeholder="Enter bonus points">
        <button id="giveBonusBtn" class="action-btn reset-btn">Give Bonus</button>
      </div>
      <div class="input-group" style="margin-top: 1rem;">
        <select id="userSelect" style="flex: 2;">
          <option value="">Select User</option>
        </select>
        <button id="addBonusToUserBtn" class="action-btn reset-btn">Add Bonus</button>
      </div>
    </div>
    <table class="user-list">
      <thead>
        <tr>
          <th>Username</th>
          <th>Points</th>
          <th>Last Claim</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="userList"></tbody>
    </table>
  </div>
  
  <div class="container" id="userDashboard" style="display: none;">
    <div class="auth-form">
      <button id="startTimerBtn" class="start-timer-btn">Start Timer</button>
      <div class="bonus-section" style="margin-bottom: 1rem;">
        <div class="bonus-amount">Available Bonus: <span id="availableBonus">0</span></div>
        <button id="claimBonusBtn" class="action-btn reset-btn" style="margin-top: 0.5rem;">Claim Bonus</button>
      </div>
      <h1>Welcome <span id="userDisplayName"></span></h1>
      
      <div class="points-display">
        <div class="points-item">
          <div>Regular Points</div>
          <div id="userRegPoints" class="points-value">0</div>
        </div>
        <div class="points-item">
          <div>Star Points</div>
          <div id="userStarPoints" class="points-value">0</div>
        </div>
      </div>
      
      <div class="timer-container">
        <div class="timer-display">
          <span id="timerMinutes">60</span>:<span id="timerSeconds">00</span>
        </div>
        <div class="timer-progress">
          <div id="timerProgressBar"></div>
        </div>
      </div>
      
      <div class="roulette-container">
        <div class="roulette-wheel">
          <div class="wheel-pointer"></div>
          <!-- Wheel sections will be added dynamically -->
        </div>
        <button id="spinBtn" class="spin-btn">Spin the Wheel!</button>
      </div>
      
      <div class="donation-container">
        <h3>Donate Star Points</h3>
        <div class="input-group">
          <input type="text" id="donateUsername" placeholder="Enter username to donate to">
          <button id="donateBtn" class="action-btn reset-btn">Donate 25 Points (Cost: 50)</button>
        </div>
        <div class="donation-info">
          Each donation costs 50 star points (25 points donated + 25 points fee)
          and gives you 1 free spin!
        </div>
      </div>
      
      <button id="userLogout" style="margin-top: 1rem;">Logout</button>
    </div>
    <div class="warning-message">
      <strong>⚠️ WARNING:</strong>
      Pede ma ban ang mahuhuling mandaya sa pagkuha ng points.<br>
      Mag login lang kapag naglaro!,
      Bawal mag register ng dalawa o maraming account,
      Sa internet shop lang pede iopen ang reward app
    </div>
    <div class="leaderboard">
      <h2>🏆 Top 10 Players</h2>
      <ul class="leaderboard-list" id="leaderboardList">
        <!-- Leaderboard items will be inserted here -->
      </ul>
    </div>
  </div>
  
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, child, remove, update, push, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyD2HNdwfHLo1nMb4wm4z83uR4TEjUiM6_g",
    authDomain: "jns-reward-points.firebaseapp.com",
    databaseURL: "https://jns-reward-points-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jns-reward-points",
    storageBucket: "jns-reward-points.appspot.com",
    messagingSenderId: "856311133669",
    appId: "1:856311133669:web:ff09d06d3a8a83ec9bab0c",
    measurementId: "G-KD8HC3H0J1"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let leaderboardListener = null; // Add this line to track the listener
  let notificationsListener = null; // Add this line to track notifications listener
  
  // UI Elements
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const showRegisterLink = document.getElementById('showRegister');
  const showLoginLink = document.getElementById('showLogin');
  const adminContainer = document.getElementById('adminContainer');
  const userDashboard = document.getElementById('userDashboard');
  const loginContainer = document.getElementById('loginContainer');
  const registerContainer = document.getElementById('registerContainer');
  
  // Switch between login and register forms
  showRegisterLink.addEventListener('click', (e) => {
    e.preventDefault();
    loginContainer.style.display = 'none';
    registerContainer.style.display = 'block';
  });
  
  showLoginLink.addEventListener('click', (e) => {
    e.preventDefault();
    loginContainer.style.display = 'block';
    registerContainer.style.display = 'none';
  });
  
  // Add this function for random time generation
  function getRandomTime() {
    return Math.floor(Math.random() * (60 - 42 + 1) + 42) * 60;
  }

  // Register new user
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('regUsername').value;
    const password = document.getElementById('regPassword').value;
  
    try {
      const userRef = ref(db, 'users/' + username);
      const snapshot = await get(userRef);
      
      if (snapshot.exists()) {
        alert('Username already exists!');
        return;
      }
  
      // Initialize user with lastSpin as null to allow first spin
      await set(userRef, {
        username,
        password,
        points: 0,
        starPoints: 0,
        availableBonus: 0,
        lastClaim: null,
        lastBonusClaim: null,
        lastSpin: null,  // Explicitly set lastSpin as null
        timerState: null
      });
  
      alert('Registration successful!');
      registerForm.reset();
      loginContainer.style.display = 'block';
      registerContainer.style.display = 'none';
    } catch (error) {
      console.error(error);
      alert('Registration failed!');
    }
  });
  
  // Create notification
  async function createNotification(username, points) {
    try {
      const notificationsRef = ref(db, 'notifications');
      const newNotificationRef = push(notificationsRef);
      await set(newNotificationRef, {
        username,
        points,
        timestamp: new Date().toISOString(),
        read: false
      });
    } catch (error) {
      console.error('Failed to create notification:', error);
    }
  }

  // Load notifications
  async function loadNotifications() {
    try {
      const notificationsRef = ref(db, 'notifications');
      const notificationsDiv = document.getElementById('adminNotifications');
      
      if (!notificationsDiv) return;
      
      // Remove existing listener if it exists
      if (notificationsListener) {
        notificationsListener();
      }
      
      // Store the new listener
      notificationsListener = onValue(notificationsRef, (snapshot) => {
        if (!notificationsDiv) return;
        
        notificationsDiv.innerHTML = '<h2>Recent Claims</h2>';
        
        if (snapshot.exists()) {
          const notifications = [];
          snapshot.forEach((child) => {
            notifications.push({ id: child.key, ...child.val() });
          });
          
          notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          
          notifications.forEach((notification) => {
            const notificationEl = document.createElement('div');
            notificationEl.className = 'notification';
            notificationEl.innerHTML = `
              <div>User <strong>${notification.username}</strong> claimed their daily point</div>
              <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
            `;
            notificationsDiv.appendChild(notificationEl);
          });
        }
      });
    } catch (error) {
      console.error('Failed to load notifications:', error);
    }
  }

  // Load user list and notifications
  const loadUserList = async () => {
    const userList = document.getElementById('userList');
    userList.innerHTML = '';
  
    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          const user = child.val();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.points || 0}</td>
            <td>${user.lastClaim ? new Date(user.lastClaim).toLocaleDateString() : 'Never'}</td>
            <td>
              <button class="action-btn reset-btn" onclick="window.resetPoints('${user.username}')">Reset</button>
              <button class="action-btn delete-btn" onclick="window.deleteUser('${user.username}')">Delete</button>
            </td>
          `;
          userList.appendChild(row);
        });
      }
      updateUserSelect(); // Add this line to update dropdown when user list loads
      loadNotifications(); // Load notifications
    } catch (error) {
      console.error(error);
      alert('Failed to load user list!');
    }
  }

  // Update user select dropdown
  function updateUserSelect() {
    const userSelect = document.getElementById('userSelect');
    
    // Clear existing options except the first one
    while (userSelect.options.length > 1) {
      userSelect.remove(1);
    }
    
    // Get users and add to dropdown
    get(ref(db, 'users')).then((snapshot) => {
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          const user = child.val();
          const option = document.createElement('option');
          option.value = user.username;
          option.textContent = user.username;
          userSelect.appendChild(option);
        });
      }
    }).catch((error) => {
      console.error('Failed to load users for dropdown:', error);
    });
  }

  // Add bonus to specific user
  document.getElementById('addBonusToUserBtn').addEventListener('click', async () => {
    const selectedUser = document.getElementById('userSelect').value;
    const bonusAmount = parseInt(document.getElementById('bonusPoints').value);
    
    if (!selectedUser) {
      alert('Please select a user');
      return;
    }
    
    if (!bonusAmount || bonusAmount <= 0) {
      alert('Please enter a valid bonus amount');
      return;
    }

    try {
      const userBonusRef = ref(db, `users/${selectedUser}/availableBonus`);
      await set(userBonusRef, bonusAmount);
      alert(`Bonus of ${bonusAmount} points set for user ${selectedUser}`);
    } catch (error) {
      console.error('Failed to set user bonus:', error);
      alert('Failed to set user bonus');
    }
  });

  // Modify the give bonus button click handler
  document.getElementById('giveBonusBtn').addEventListener('click', async () => {
    const bonusAmount = parseInt(document.getElementById('bonusPoints').value);
    
    if (!bonusAmount || bonusAmount <= 0) {
      alert('Please enter a valid bonus amount');
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      
      if (snapshot.exists()) {
        const updates = {};
        
        snapshot.forEach((child) => {
          updates[`users/${child.key}/availableBonus`] = bonusAmount;
        });
        
        // Update all users simultaneously
        await update(ref(db), updates);
        alert(`Bonus of ${bonusAmount} points set for all users`);
        document.getElementById('bonusPoints').value = ''; // Clear input
      }
    } catch (error) {
      console.error('Failed to distribute bonus:', error);
      alert('Failed to distribute bonus to users');
    }
  });

  // Update leaderboard
  async function updateLeaderboard() {
    try {
      const usersRef = ref(db, 'users');
      const currentUser = sessionStorage.getItem('currentUser');
      const leaderboardList = document.getElementById('leaderboardList');
      
      if (!leaderboardList) return; // Early return if element doesn't exist
      
      // Remove existing listener if it exists
      if (leaderboardListener) {
        leaderboardListener();
      }
      
      // Store the new listener
      leaderboardListener = onValue(usersRef, (snapshot) => {
        const leaderboardList = document.getElementById('leaderboardList');
        if (!leaderboardList) return; // Check again inside callback
        
        if (snapshot.exists()) {
          const users = [];
          snapshot.forEach((child) => {
            users.push({
              username: child.val().username,
              points: child.val().points || 0,
              starPoints: child.val().starPoints || 0
            });
          });
          
          // Sort by regular points first, then star points
          users.sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            return b.starPoints - a.starPoints;
          });
          
          const top10 = users.slice(0, 10);
          leaderboardList.innerHTML = '';
          
          top10.forEach((user, index) => {
            const li = document.createElement('li');
            li.className = `leaderboard-item${user.username === currentUser ? ' current-user' : ''}`;
            li.innerHTML = `
              <span class="leaderboard-rank">#${index + 1}</span>
              <span class="leaderboard-username">${user.username}</span>
              <span class="leaderboard-points">${user.points} pts | ⭐ ${user.starPoints}</span>
            `;
            leaderboardList.appendChild(li);
          });
        }
      });
    } catch (error) {
      console.error('Failed to update leaderboard:', error);
    }
  }

  // Add null checks to points display update
  function updateUserPointsDisplay(userData) {
    const regPointsEl = document.getElementById('userRegPoints');
    const starPointsEl = document.getElementById('userStarPoints');
    
    if (regPointsEl) {
      regPointsEl.textContent = userData.points || 0;
    }
    if (starPointsEl) {
      starPointsEl.textContent = userData.starPoints || 0;
    }
  }

  // Update login handler with null checks
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    if (username === 'lem' && password === 'lem1234') {
      loginContainer.style.display = 'none';
      adminContainer.style.display = 'block';
      loadUserList();
      return;
    }

    try {
      const userRef = ref(db, 'users/' + username);
      const snapshot = await get(userRef);
      
      if (!snapshot.exists()) {
        alert('User not found!');
        return;
      }

      const userData = snapshot.val();
      if (userData.password !== password) {
        alert('Invalid password!');
        return;
      }

      const userDisplayEl = document.getElementById('userDisplayName');
      if (userDisplayEl) {
        userDisplayEl.textContent = username;
      }
      
      updateUserPointsDisplay(userData);
      
      if (loginContainer) loginContainer.style.display = 'none';
      if (userDashboard) userDashboard.style.display = 'block';

      // Store current user
      sessionStorage.setItem('currentUser', username);
      
      // Start fresh timer with random duration
      timeRemaining = getRandomTime();
      startTimer();
    
      // Add real-time points update listener
      const userPointsRef = ref(db, `users/${username}`);
      onValue(userPointsRef, (snapshot) => {
        const userData = snapshot.val();
        updateUserPointsDisplay(userData);
      });

      checkStartTimerButton();
      createWheelSections();
      const spinBtn = document.getElementById('spinBtn');
      if (spinBtn) {
        spinBtn.addEventListener('click', spinWheel);
      }
      updateLeaderboard();
      checkAndUpdateBonus();
      initializeTimer();
    } catch (error) {
      console.error(error);
    }
  });

  // Add auto-login check on page load
  window.addEventListener('load', async () => {
    const savedUsername = sessionStorage.getItem('currentUser');
    if (savedUsername) {
      try {
        const userRef = ref(db, `users/${savedUsername}`);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          const userData = snapshot.val();
          const userDisplayEl = document.getElementById('userDisplayName');
          if (userDisplayEl) {
            userDisplayEl.textContent = savedUsername;
          }
          
          updateUserPointsDisplay(userData);
          
          if (loginContainer) loginContainer.style.display = 'none';
          if (userDashboard) userDashboard.style.display = 'block';

          // Initialize all user dashboard features
          checkStartTimerButton();
          createWheelSections();
          const spinBtn = document.getElementById('spinBtn');
          if (spinBtn) {
            spinBtn.addEventListener('click', spinWheel);
          }
          updateLeaderboard();
          checkAndUpdateBonus();
          initializeTimer();
        }
      } catch (error) {
        console.error('Auto-login failed:', error);
        sessionStorage.removeItem('currentUser');
      }
    }
  });

  // Check and update bonus
  async function checkAndUpdateBonus() {
    const username = sessionStorage.getItem('currentUser');
    if (!username) return;

    try {
      const userRef = ref(db, `users/${username}`);
      
      onValue(userRef, (snapshot) => {
        const userData = snapshot.val();
        const availableBonus = userData.availableBonus || 0;
        const lastBonusClaim = userData.lastBonusClaim ? new Date(userData.lastBonusClaim) : new Date(0);
        const today = new Date();
        
        // Update UI
        document.getElementById('availableBonus').textContent = availableBonus;
        document.getElementById('claimBonusBtn').disabled = lastBonusClaim.toDateString() === today.toDateString();
      });
    } catch (error) {
      console.error('Failed to check bonus:', error);
    }
  }

  document.getElementById('claimBonusBtn').addEventListener('click', async () => {
    const username = sessionStorage.getItem('currentUser');
    if (!username) return;

    try {
      const userRef = ref(db, `users/${username}`);
      const snapshot = await get(userRef);
      const userData = snapshot.val();
      
      const lastBonusClaim = userData.lastBonusClaim ? new Date(userData.lastBonusClaim) : new Date(0);
      const today = new Date();

      if (lastBonusClaim.toDateString() === today.toDateString()) {
        alert('You have already claimed your bonus today');
        return;
      }

      const availableBonus = userData.availableBonus || 0;
      if (availableBonus <= 0) {
        alert('No bonus available to claim');
        return;
      }

      // Update user points and clear bonus
      const newPoints = (userData.points || 0) + availableBonus;
      await update(userRef, {
        points: newPoints,
        availableBonus: 0,
        lastBonusClaim: today.toISOString()
      });

      updateUserPointsDisplay({ points: newPoints });
      document.getElementById('claimBonusBtn').disabled = true;
      document.getElementById('availableBonus').textContent = '0';
      
      alert(`Successfully claimed ${availableBonus} bonus points!`);
      updateLeaderboard();
    } catch (error) {
      console.error('Failed to claim bonus:', error);
      alert('Failed to claim bonus');
    }
  });

  // Check start timer button state
  async function checkStartTimerButton() {
    const username = sessionStorage.getItem('currentUser');
    if (!username) return;

    try {
      const userRef = ref(db, `users/${username}`);
      
      onValue(userRef, (snapshot) => {
        const userData = snapshot.val();
        const lastTimerStart = userData.lastTimerStart ? new Date(userData.lastTimerStart) : new Date(0);
        const today = new Date();
        
        // Disable button if already used today
        document.getElementById('startTimerBtn').disabled = lastTimerStart.toDateString() === today.toDateString();
      });
    } catch (error) {
      console.error('Failed to check timer button state:', error);
    }
  }

  // Start timer button functionality
  document.getElementById('startTimerBtn').addEventListener('click', async () => {
    const username = sessionStorage.getItem('currentUser');
    if (!username) return;

    try {
      const userRef = ref(db, `users/${username}`);
      const snapshot = await get(userRef);
      const userData = snapshot.val();
      
      const lastTimerStart = userData.lastTimerStart ? new Date(userData.lastTimerStart) : new Date(0);
      const today = new Date();

      if (lastTimerStart.toDateString() === today.toDateString()) {
        alert('You can only start the timer once per day');
        return;
      }

      // Update lastTimerStart and remove both lastBonusClaim and lastClaim
      await update(userRef, {
        lastTimerStart: today.toISOString(),
        lastBonusClaim: null,
        lastClaim: null  // Added this line to delete lastClaim
      });

      document.getElementById('startTimerBtn').disabled = true;
      alert('Timer reset successful! You can now start a new timer session.');
      
      // Refresh bonus claim button state and reinitialize timer
      checkAndUpdateBonus();
      timeRemaining = getRandomTime();  // Reset timer to random duration
      startTimer();  // Restart timer
    } catch (error) {
      console.error('Failed to start timer:', error);
      alert('Failed to start timer');
    }
  });

  // Admin functions
  window.resetPoints = async (username) => {
    try {
      const userRef = ref(db, `users/${username}`);
      const snapshot = await get(userRef);
      const userData = snapshot.val();
      
      await update(userRef, { 
        lastClaim: null,
        lastSpin: null,
        lastBonusClaim: null,
        lastTimerStart: null
      });
      
      alert('Reset successful!');
      loadUserList();
    } catch (error) {
      console.error(error);
      alert('Failed to reset user!');
    }
  };
  
  window.deleteUser = async (username) => {
    if (!confirm(`Are you sure you want to delete user ${username}?`)) return;
    
    try {
      await remove(ref(db, 'users/' + username));
      alert('User deleted successfully!');
      loadUserList();
    } catch (error) {
      console.error(error);
      alert('Failed to delete user!');
    }
  };
  
  // Donation functionality
  document.getElementById('donateBtn').addEventListener('click', async () => {
    const donorUsername = sessionStorage.getItem('currentUser');
    const recipientUsername = document.getElementById('donateUsername').value.trim();
    
    if (!donorUsername || !recipientUsername) {
      alert('Please enter a username to donate to');
      return;
    }

    if (donorUsername === recipientUsername) {
      alert('You cannot donate to yourself');
      return;
    }

    try {
      const donorRef = ref(db, `users/${donorUsername}`);
      const recipientRef = ref(db, `users/${recipientUsername}`);
      
      // Get donor data
      const donorSnapshot = await get(donorRef);
      if (!donorSnapshot.exists()) {
        alert('Error accessing your account');
        return;
      }
      
      // Get recipient data
      const recipientSnapshot = await get(recipientRef);
      if (!recipientSnapshot.exists()) {
        alert('Recipient user not found');
        return;
      }
      
      const donorData = donorSnapshot.val();
      const recipientData = recipientSnapshot.val();
      
      // Ensure starPoints are numbers with default of 0
      const donorStarPoints = parseInt(donorData.starPoints || 0);
      const recipientStarPoints = parseInt(recipientData.starPoints || 0);
      
      // Check if donor has enough star points
      if (donorStarPoints < 50) {
        alert('You need at least 50 star points to make a donation');
        return;
      }
      
      // Update both users' star points
      await update(donorRef, {
        starPoints: donorStarPoints - 50,
        lastSpin: null // Reset spin to allow one free spin
      });
      
      await update(recipientRef, {
        starPoints: recipientStarPoints + 25
      });
      
      alert(`Successfully donated 25 star points to ${recipientUsername}! You can now spin the wheel once.`);
      document.getElementById('donateUsername').value = '';
      
      // Enable spin button immediately after successful donation
      document.getElementById('spinBtn').disabled = false;
      
      // Update leaderboard
      updateLeaderboard();
    } catch (error) {
      console.error('Donation failed:', error);
      alert('Failed to process donation');
    }
  });

  // Logout functions
  document.getElementById('adminLogout')?.addEventListener('click', () => {
    if (notificationsListener) {
      notificationsListener();
      notificationsListener = null; // Clear the reference
    }
    adminContainer.style.display = 'none';
    loginContainer.style.display = 'block';
    loginForm.reset();
  });
  
  document.getElementById('userLogout')?.addEventListener('click', async () => {
    // Remove leaderboard listener if it exists
    if (leaderboardListener) {
      leaderboardListener();
      leaderboardListener = null; // Clear the reference
    }
    userDashboard.style.display = 'none';
    loginContainer.style.display = 'block';
    loginForm.reset();
    sessionStorage.removeItem('currentUser');
    clearInterval(timerInterval);
  });
  
  // Timer functions
  let timerInterval;
  let timeRemaining;

  function displayTimer(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    
    document.getElementById('timerMinutes').textContent = String(minutes).padStart(2, '0');
    document.getElementById('timerSeconds').textContent = String(remainingSeconds).padStart(2, '0');
    
    const progress = (seconds / timeRemaining) * 100;
    document.getElementById('timerProgressBar').style.width = `${progress}%`;
  }

  function startTimer() {
    clearInterval(timerInterval);
    displayTimer(timeRemaining);
    
    timerInterval = setInterval(async () => {
      timeRemaining--;
      displayTimer(timeRemaining);

      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        await awardPoint();
      }
    }, 1000);
  }

  async function awardPoint() {
    const username = sessionStorage.getItem('currentUser');
    if (!username) return;

    try {
      const userRef = ref(db, `users/${username}`);
      const snapshot = await get(userRef);
      const userData = snapshot.val();

      const newPoints = (userData.points || 0) + 1;
      await update(userRef, {
        points: newPoints,
        lastClaim: new Date().toISOString()
      });

      updateUserPointsDisplay({ points: newPoints });
      await createNotification(username, newPoints);
      updateLeaderboard();
    } catch (error) {
      console.error('Failed to award point:', error);
    }
  }

  // Roulette functionality
  let wheelSpinning = false;
  const WHEEL_SECTIONS = 20; // Changed from 10 to 20

  // Create wheel sections with rewards
  function createWheelSections() {
    const wheel = document.querySelector('.roulette-wheel');
    for (let i = 0; i < WHEEL_SECTIONS; i++) {
      const section = document.createElement('div');
      section.className = 'wheel-section';
      section.style.transform = `rotate(${i * (360 / WHEEL_SECTIONS)}deg)`;
      section.style.backgroundColor = i === 0 ? '#ffd700' : `hsl(${i * (360/WHEEL_SECTIONS)}, 70%, 50%)`;
      section.textContent = i === 0 ? 'JACKPOT' : `${Math.floor(Math.random() * 21 + 10)}`; // Changed to 10-30 range
      wheel.appendChild(section);
    }
  }

  // Spin wheel functionality
  async function spinWheel() {
    if (wheelSpinning) return;
    
    const username = sessionStorage.getItem('currentUser');
    if (!username) return;

    try {
      const userRef = ref(db, `users/${username}`);
      const snapshot = await get(userRef);
      const userData = snapshot.val();

      // More explicit handling of lastSpin for new users
      const lastSpin = userData.lastSpin ? new Date(userData.lastSpin) : null;
      const today = new Date();
      
      // Allow spin if lastSpin is null (new user) or from a different day
      if (lastSpin && lastSpin.toDateString() === today.toDateString()) {
        alert('You can only spin once per day!');
        return;
      }

      wheelSpinning = true;
      document.getElementById('spinBtn').disabled = true;

      // 25% chance of winning jackpot
      const willWin = Math.random() < 0.25;
      const rotations = 5; // Number of full rotations
      const section = willWin ? 0 : Math.floor(Math.random() * 19) + 1;
      const degree = rotations * 360 + (section * (360 / WHEEL_SECTIONS));
      
      const wheel = document.querySelector('.roulette-wheel');
      wheel.style.transform = `rotate(${degree}deg)`;

      setTimeout(async () => {
        wheelSpinning = false;
        
        // Ensure points and starPoints are numbers
        const points = parseInt(userData.points || 0);
        const starPoints = parseInt(userData.starPoints || 0);
        
        if (willWin) {
          await update(userRef, {
            points: points + 1,
            lastSpin: today.toISOString()
          });
          alert('Congratulations! You won a regular point!');
        } else {
          // Parse the reward as integer and ensure it's a valid number
          const reward = parseInt(wheel.children[section].textContent);
          if (isNaN(reward)) {
            console.error('Invalid reward value');
            return;
          }
          
          await update(userRef, {
            starPoints: starPoints + reward,
            lastSpin: today.toISOString()
          });
          alert(`You won ${reward} star points!`);
        }
        
        updateLeaderboard();
      }, 4000);

    } catch (error) {
      console.error('Failed to spin wheel:', error);
      alert('Failed to spin wheel');
    }
  }

  // Add window beforeunload handler
  window.addEventListener('beforeunload', async () => {
    // Remove timer state saving functionality
  });
  </script>
  </body>
  </html>